<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>게시글목록</title>
  <link rel="stylesheet" th:href="@{/css/bbs/list.css}">
  <script th:src="@{/js/bbs/list.js}" defer></script>

  <style>
    .active {
      color: red;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div class="userInfo" th:if="${session.loginOkMember != null}">
    <h3 th:if="${session.loginOkMember.gubun == 'general'}" id="generalInfo">회원정보</h3>
    <h3 th:if="${session.loginOkMember.gubun == 'admin'}" id="adminInfo">관리자 정보</h3>
    <p><strong>이메일: </strong><span th:text="${session.loginOkMember.email}"></span></p>
    <p><strong>별칭: </strong><span id="userNickname" th:text="${session.loginOkMember.nickname}"></span></p>
    <p><a href="/logout">로그아웃</a></p>
  </div>
  <div class="nonLogin" th:if="${session.loginOkMember == null}">
    <h3>비로그인 상태입니다.</h3>
    <span><a href="/members/join">회원가입</a></span><span><a href="/login">로그인</a></span>
  </div>
  <div class="container">
    <h3>게시글목록</h3>
    <form action="/bbs/del" method="post" id="frm">
      <table>
        <thead>
          <tr class="index">
            <th><input type="checkbox" id="selectAll"><label for="selectAll">전체 선택</label></th>
            <th>게시글번호</th>
            <th>작성자</th>
            <th class="title">제목</th>
            <th>작성날짜</th>
            <th>수정날짜</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="bbs : ${all}">
            <td><input type="checkbox" name="bbsIds" id="" th:value="${bbs.bbsId}"></td>
            <td th:text="${bbs.bbsId}">1</td>
            <td class="writer" th:text="${bbs.writer}">작성자</td>
            <td class="title">
              <a th:href="@{/bbs/{id}(id=${bbs.bbsId})}" th:text="${bbs.title}">제목</a>
            </td>
            <td th:text="${bbs.cdate}">작성 날짜</td>
            <td th:text="${bbs.udate}">수정 날짜</td>
          </tr>
        </tbody>
      </table>
    </form>
    <div class="paging-button-wrap">
      <div class="paginationWrap" id="pagination" th:data-total-records="${totalRecords}">
        <!-- 여기에 페이징이 들어와야 됩니다.-->

      </div>
      <div class="buttonWrap">
        <button id="btnHome">초기화면</button>
        <button id="btnDels" th:if="${!session.isEmpty()}">삭제</button>
        <button class="btnAdd" id="btnAdd" th:if="${!session.isEmpty()}">게시글작성</button>
      </div>
    </div>
  </div>
  <script>

    // window.location.search: 현재 URL에서 ? 뒤의 쿼리 문자열만 가져옵니다. (예: "?page=2&category=books")
    // new URLSearchParams(): 쿼리 문자열을 읽고, 개별 키-값 쌍으로 다룰 수 있는 객체를 생성합니다.

    const urlParams = new URLSearchParams(window.location.search);

    // 쿼리스트링에서 'page' 값 읽기, 없으면 1
    // .get('key'): 쿼리 문자열에서 특정 키의 값을 가져옵니다.
    // 결과는 문자열로 반환됩니다. 숫자가 필요하다면 parseInt()를 사용합니다.
    const currentPageFromURL = parseInt(urlParams.get('page'), 10) || 1;
    const currentPageFromServer = currentPageFromURL;
    class Pagination {
      constructor(recordsPerPage, pagesPerPage) {
        this.totalRecords = 0;                     //총 레코드수
        this.recordsPerPage = recordsPerPage;       //페이지당 레코드 수
        this.pagesPerPage = pagesPerPage;           //페이지당 페이지 수
        this.currentPage = currentPageFromServer;   //현재 페이지
        this.currentPageGroupStart = 1;             //현재 페이지의 시작페이지
      }

      getTotalPages() {
        return Math.ceil(this.totalRecords / this.recordsPerPage);     //페이지랑 레코드수를 전체 레코드수로 나눈뒤 올림을 하면 필요한 총 페이지 수가 나옴
      }

      goToPage(pageNumber) {
        const totalPages = this.getTotalPages();
        if (pageNumber < 1 || pageNumber > totalPages) {
          return; // 유효하지 않은 페이지 번호일 경우 아무것도 하지 않음
        }
        this.currentPage = pageNumber;
        console.log("goToPage의 currentPage:", this.currentPage);
        this.currentPageGroupStart = Math.floor((pageNumber - 1) / this.pagesPerPage) * this.pagesPerPage + 1; // 페이지 그룹 업데이트

        // URL 갱신
        //window.history.pushState의 원리와 사용법
        //window.history.pushState는 브라우저의 **히스토리(뒤로 가기/앞으로 가기)**를 관리하는 메서드입니다. 
        //이를 사용하면 페이지를 새로고침하지 않고도 URL을 변경할 수 있습니다.
        const newURL = `${window.location.pathname}?page=${pageNumber}`;
        window.history.pushState({ page: pageNumber }, '', newURL);
      }

      displayNavigation() {
        console.log("displayNavigation 호출됨");
        const totalPages = this.getTotalPages();
        let pageNavigation = '';
        // 시작이 1페이지가 아니라면 처음과 이전버튼을 생성
        if (this.currentPageGroupStart > 1) {
          pageNavigation += '<a href="#" class="nav-link" data-page="1">처음</a> <a href="#" class="nav-link" data-page="' + (this.currentPageGroupStart - 1) + '">이전</a> ';
        }
        for (let i = this.currentPageGroupStart; i <= totalPages; i++) {

          if (i === this.currentPage) {
            pageNavigation += `<span class="active" id="page${i}">${i}</span> `; // 현재 페이지는 버튼이 아닌 span으로 표시
          } else {
            pageNavigation += `<a href="" class="nav-link" data-page="${i}" id="page${i}">${i}</a> `; // 페이지 링크
          }
        }
        // 다음과 마지막 버튼 추가
        if (this.currentPageGroupStart + this.pagesPerPage - 1 < totalPages) {
          pageNavigation += '<a href="" class="nav-link" data-page="' + (this.currentPageGroupStart + this.pagesPerPage) + '">다음</a> <a href="#" class="nav-link" data-page="' + totalPages + '">끝</a>';
        }

        return pageNavigation;
      }

      //다음 그룹 페이지로 이동 : 현재 페이지 그룹의 시작페이지를 페이지 수만큼 증가 ex) (1 2 3 4 5  -> 6 7 8 9 10)
      setNextPageGroup() {
        this.currentPageGroupStart += this.pagesPerPage;
      }

      //이전 그룹 페이지로 이동 : 현재 페이지 그룹의 시작페이지를 페이지 수만큼 감소 ex) (6 7 8 9 10) -> (1 2 3 4 5)
      setPrevPageGroup() {
        this.currentPageGroupStart -= this.pagesPerPage;
        //연산결과가 1보다 작으면 첫페이지라는 뜻이므로, 이를 체크
        if (this.currentPageGroupStart < 1) {
          this.currentPageGroupStart = 1;
        }
      }
    }

    const pagination = new Pagination(5, 5);    // 한페이지의 게시글 갯수 , 한 페이지그룹의 페이지 갯수
    const totalRecords = parseInt(document.getElementById('pagination').dataset.totalRecords, 10);//여기에 bbs 테이블의 레코드 수를 가져와야함. SELECT COUNT(*) FROM BBS;
    pagination.totalRecords = totalRecords;


    function displayPagination() {
      console.log("displayPagination 호출됨"); // 추가된 로그
      // console.log("Total Records:", totalRecords);
      document.getElementById('pagination').innerHTML = pagination.displayNavigation();

      // 페이지 링크에 대한 이벤트 리스너 추가
      const navLinks = document.querySelectorAll('.nav-link');
      navLinks.forEach(link => {
        link.addEventListener('click', function (e) {
          const pageNumber = parseInt(this.getAttribute('data-page'));
          pagination.goToPage(pageNumber); // 페이지 이동
          //이부분의 필요성에 대한
          displayPagination(); // UI 업데이트
        });
      });

      if (document.getElementById('first')) {
        document.getElementById('first').addEventListener('click', function () {
          pagination.goToPage(1);
          displayPagination();
        });
      }
      if (document.getElementById('prev')) {
        document.getElementById('prev').addEventListener('click', function () {
          if (pagination.currentPageGroupStart > 1) {
            pagination.setPrevPageGroup();
            pagination.goToPage(pagination.currentPageGroupStart);
            displayPagination();
          }
        });
      }

      if (document.getElementById('next')) {
        document.getElementById('next').addEventListener('click', function () {
          if (pagination.currentPageGroupStart + pagination.pagesPerPage - 1 < pagination.getTotalPages()) {
            pagination.setNextPageGroup();
            pagination.goToPage(pagination.currentPageGroupStart);
            displayPagination();
          }
        });
      }
      if (document.getElementById('last')) {
        document.getElementById('last').addEventListener('click', function () {
          const totalPages = pagination.getTotalPages();
          pagination.goToPage(totalPages);
          displayPagination();
        });
      }
    }
    displayPagination();
  </script>
</body>

</html>